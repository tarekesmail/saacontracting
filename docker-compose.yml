version: '3.8'

services:
  # Application
  app:
    build:
      context: .
      dockerfile: Dockerfile.debian
    container_name: saa_contracting_app
    environment:
      DATABASE_URL: "postgresql://postgres:mysecretpassword@host.docker.internal:5432/saa_contracting"
      JWT_SECRET: "saa-contracting-jwt-secret-key-change-in-production"
      NODE_ENV: "production"
      PORT: 3000
    ports:
      - "127.0.0.1:3000:3000"  # Only expose locally for Nginx proxy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./prisma:/app/prisma
    restart: unless-stopped
    command: >
      sh -c "
        npx prisma migrate deploy &&
        node dist/server/index.js
      "

# Using external postgres container
networks:
  default:
    external: true
    name: bridge